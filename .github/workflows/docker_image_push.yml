name: Build & Push Docker Image

# 푸시가 발생하면 실행 (main 브랜치만)
on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: edu   # edu 폴더 기준으로 실행

    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Maven 캐시 (의존성 재다운로드 방지)
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      # 3. Docker BuildKit 활성화 + 캐시 마운트 지원
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: momoclass5
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. Docker 이미지 빌드 & 푸시 (캐시 포함!)
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: edu
          file: edu/Dockerfile
          push: true
          tags: misun1234/edu:latest
          cache-from: type=registry,ref=misun1234/edu:latest
          cache-to: type=inline
